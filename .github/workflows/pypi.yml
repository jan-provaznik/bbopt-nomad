name: Build and publish binary wheels.

on:
  workflow_dispatch:

jobs:

  build:
    strategy:
      fail-fast: false
      matrix:
        target:
          - name: windows-gcc
            os: windows-latest
            archs: AMD64
            cxx: x86_64-w64-mingw32-g++
            cc: x86_64-w64-mingw32-gcc
            cmake_generator: -G 'MinGW Makefiles'

          - name: windows-msvc
            os: windows-latest
            archs: AMD64
            cxx: cl
            cc: cl
            msvc: 1
            environment_script: "C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/Auxiliary/Build/vcvars64.bat"

          - name: ubuntu-gcc
            os: ubuntu-latest
            archs: x86_64
            cxx: g++
            cc: gcc

          - name: macos-gcc
            os: macos-latest
            archs: x86_64
            cxx: g++
            cc: gcc

    name: Build binary wheels for ${{ matrix.target.name }} platform.
    runs-on: ${{ matrix.target.os }}

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v3

    - name: Build binary wheels
      uses: pypa/cibuildwheel@v2.12.0
      env:
        CIBW_ARCHS: >-
          ${{ matrix.target.archs }}
        CIBW_PROJECT_REQUIRES_PYTHON: >-
          >=3.10
        CIBW_BEFORE_ALL: >-
          cmake ${{ matrix.target.cmake_generator }} -DTEST_OPENMP=OFF -DBUILD_INTERFACE_PYTHON=OFF -DBUILD_EXAMPLES=OFF -S . -B build &&
          cmake --build build --config Release --target clean &&
          cmake --build build --config Release --target nomadStatic &&
          cmake --build build --config Release --target sgtelibStatic
        CIBW_BEFORE_BUILD: >-
          pip install cython setuptools
        CIBW_ENVIRONMENT: >-
          CC=${{ matrix.target.cc }}
          CXX=${{ matrix.target.cxx }}
          NOMAD_SRC=../../src
          NOMAD_BUILD_DIR=../../build
          NOMAD_MSVC_FLAG=${{ matrix.target.msvc }}
          NOMAD_MSVC_CONF=Release
        CIBW_BUILD_VERBOSITY: >-
          3
      with:
        output-dir: wheelhouse
        package-dir: interfaces/PyNomad

    - name: Collect wheels
      uses: actions/upload-artifact@v3
      with:
        path: wheelhouse/*.whl

  publish:
    name: Publish wheels to PyPi
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Collect wheels
      uses: actions/download-artifact@v3
      with:
        name: artifact
        path: wheelhouse

    - name: Publish to PyPi
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository_url: https://test.pypi.org/legacy/
        password: ${{ secrets.PYPI_API_TOKEN }}
        packages_dir: wheelhouse
        skip_existing: true


